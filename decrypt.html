<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Rail Fence Stego Decoder</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; margin-top: 50px; }
        #result { margin-top: 20px; font-weight: bold; color: green; }
        #error { color: red; }
    </style>
</head>
<body>
    <h2>Decrypt Rail Fence Stego Image</h2>
    <input type="file" id="imageInput" accept="image/png">
    <br><br>
    <label for="rails">Number of Rails:</label>
    <input type="number" id="rails" min="2" required>
    <br><br>
    <button id="decryptButton">Decrypt</button>
    <p id="result"></p>
    <p id="error"></p>

    <script>
        let ciphertext = '';

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('imageInput').addEventListener('change', handleImageUpload);
            document.getElementById('decryptButton').addEventListener('click', decrypt);
        });

        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        canvas.width = img.width;
                        canvas.height = img.height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0);
                        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                        extractLSB(imageData.data);
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            } else {
                console.log("No file selected");
            }
        }

        function extractLSB(imageData) {
            let binary = '';
            for (let i = 0; i < imageData.length; i += 4) { // RGB channels
                binary += (imageData[i] & 1).toString();    // Red LSB
                binary += (imageData[i + 1] & 1).toString(); // Green LSB
                binary += (imageData[i + 2] & 1).toString(); // Blue LSB
                if (binary.length >= 8 * 1000) break; // Limit to 1000 chars
            }
            console.log("Extracted binary length:", binary.length);
            if (binary.length < 8) {
                console.log("Binary too short for valid ciphertext");
                document.getElementById('error').innerText = 'Extracted data too short to decode.';
                return;
            }
            ciphertext = '';
            for (let i = 0; i < binary.length; i += 8) {
                let byte = binary.substr(i, 8);
                if (byte.length < 8) {
                    console.log("Incomplete byte at:", i);
                    break;
                }
                let char_code = parseInt(byte, 2);
                if (char_code === 0 || i / 8 >= 100) { // Limit to 100 chars
                    console.log("Null byte or limit at:", i);
                    break;
                }
                ciphertext += String.fromCharCode(char_code);
            }
            console.log("Extracted ciphertext:", ciphertext);
            document.getElementById('error').innerText = `Extracted ciphertext: ${ciphertext || 'None'}`;
        }

        function railFenceDecrypt(ciphertext, rails) {
            if (!ciphertext || rails < 2) {
                console.log("Invalid input for decrypt:", ciphertext, rails);
                return "Invalid input";
            }
            let len_rail = new Array(rails).fill(0);
            let pos = 0;
            for (let i = 0; i < ciphertext.length; i++) {
                let cycle = 2 * (rails - 1);
                let rail_idx = i % cycle;
                if (rail_idx >= rails) rail_idx = cycle - rail_idx;
                len_rail[rail_idx]++;
            }
            let rail = new Array(rails).fill('');
            let idx = 0;
            for (let i = 0; i < rails; i++) {
                rail[i] = ciphertext.substr(idx, len_rail[i]);
                idx += len_rail[i];
            }
            let result = '';
            let row = 0;
            let dir_down = false;
            for (let i = 0; i < ciphertext.length; i++) {
                if (!rail[row] || rail[row].length === 0) {
                    console.log("Rail empty or undefined at row:", row);
                    break;
                }
                result += rail[row][0];
                rail[row] = rail[row].substr(1);
                if (row === 0) dir_down = true;
                else if (row === rails - 1) dir_down = false;
                row += dir_down ? 1 : -1;
            }
            console.log("Decrypted result:", result);
            return result;
        }

        function decrypt() {
            const rails = parseInt(document.getElementById('rails').value);
            if (!ciphertext || !rails) {
                document.getElementById('error').innerText = 'Upload an image and enter rails first!';
                console.log("Decrypt called with no data:", ciphertext, rails);
                return;
            }
            const plaintext = railFenceDecrypt(ciphertext, rails);
            document.getElementById('result').innerText = `Decrypted Message: ${plaintext || 'Decryption failed'}`;
            document.getElementById('error').innerText = '';
            console.log("Final plaintext:", plaintext);
        }
    </script>
</body>
</html>
