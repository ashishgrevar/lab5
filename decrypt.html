<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Rail Fence Stego Decoder</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; margin-top: 50px; }
        #result { margin-top: 20px; font-weight: bold; }
    </style>
</head>
<body>
    <h2>Decrypt Rail Fence Stego Image</h2>
    <input type="file" id="imageInput" accept="image/png" onchange="handleImageUpload(event)">
    <br><br>
    <label for="rails">Number of Rails:</label>
    <input type="number" id="rails" min="2" required>
    <br><br>
    <button onclick="decrypt()">Decrypt</button>
    <p id="result"></p>

    <script>
        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        canvas.width = img.width;
                        canvas.height = img.height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0);
                        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                        extractLSB(imageData.data);
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        }

        function extractLSB(imageData) {
            let binary = '';
            for (let i = 0; i < imageData.length; i += 4) { // RGB channels
                binary += (imageData[i] & 1);    // Red LSB
                binary += (imageData[i + 1] & 1); // Green LSB
                binary += (imageData[i + 2] & 1); // Blue LSB
                if (binary.length >= 8 * 1000) break; // Limit to reasonable length
            }
            let ciphertext = '';
            for (let i = 0; i < binary.length; i += 8) {
                let byte = binary.substr(i, 8);
                if (byte.length === 8) {
                    ciphertext += String.fromCharCode(parseInt(byte, 2));
                } else {
                    break;
                }
            }
            sessionStorage.setItem('ciphertext', ciphertext);
        }

        function railFenceDecrypt(ciphertext, rails) {
            if (!ciphertext || rails < 2) return "Invalid input";
            let rail = [''] * rails;
            let idx = 0;
            let len_rail = [Math.floor(ciphertext.length / rails)] * rails;
            for (i in range(ciphertext.length % rails)):
                len_rail[i] += 1
            for i in range(rails):
                rail[i] = ciphertext[idx:idx + len_rail[i]]
                idx += len_rail[i]
            result = ''
            row = 0
            dir_down = False
            for i in range(len(ciphertext)):
                result += rail[row][0]
                rail[row] = rail[row][1:]
                if row == 0:
                    dir_down = True
                elif row == rails - 1:
                    dir_down = False
                row += 1 if dir_down else -1
            return result
        }

        function decrypt() {
            const rails = document.getElementById('rails').value;
            const ciphertext = sessionStorage.getItem('ciphertext') || '';
            if (ciphertext && rails) {
                const plaintext = railFenceDecrypt(ciphertext, parseInt(rails));
                document.getElementById('result').innerText = `Decrypted Message: ${plaintext}`;
            } else {
                document.getElementById('result').innerText = 'Upload an image and enter rails first!';
            }
        }
    </script>
</body>
</html>